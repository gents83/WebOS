<div class="h-full w-full flex bg-zinc-800 text-white" (click)="closeContextMenu(); closeSidebarContextMenu()">
  <!-- Sidebar -->
  <div class="w-56 flex-shrink-0 bg-zinc-900/50 p-2">
    @for(section of sidebar(); track section.name; let isFirst = $first) {
      <h3 
        class="text-sm font-semibold text-gray-400 px-2 mb-2"
        [class.mt-4]="!isFirst">
        {{ section.name }}
      </h3>
      <ul>
        @for(item of section.items; track item.name) {
          <li 
            (click)="navigateTo(item.path)"
            (contextmenu)="section.name === 'Network Locations' ? onSidebarContextMenu($event, item) : null"
            (dragover)="!isCloudDrive() ? onDragOverSidebar($event, item) : null"
            (dragleave)="!isCloudDrive() ? onDragLeaveSidebar() : null"
            (drop)="!isCloudDrive() ? onDropOnSidebar($event, item) : null"
            class="flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer text-sm transition-colors duration-100"
            [class.bg-blue-600]="currentPath() === item.path && dragOverSidebarPath() !== item.path"
            [class.hover:bg-white/10]="currentPath() !== item.path"
            [class.bg-blue-600/40]="dragOverSidebarPath() === item.path"
          >
            <img [src]="item.icon" [alt]="item.name" class="w-5 h-5">
            <span>{{ item.name }}</span>
          </li>
        }
      </ul>
    }
  </div>

  <!-- Main Content -->
  <div class="flex-grow flex flex-col relative">
    <!-- Toolbar -->
    <div class="h-12 flex-shrink-0 flex items-center justify-between px-4 border-b border-white/10 gap-4">
       <div class="flex items-center gap-4 flex-grow">
          <button 
             (click)="createNewItem('folder')"
             [disabled]="isSearching() || isCloudDrive()"
             class="flex items-center gap-2 px-3 py-1.5 bg-zinc-700 hover:bg-zinc-600 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
             <svg class="w-4 h-4 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" d="M12 10.5v6m3-3H9m4.06-7.19-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" />
             </svg>
             New Folder
          </button>
          <div class="text-sm text-gray-300 truncate flex-shrink min-w-0">Path: {{ currentPath() }}</div>
       </div>
       <div class="relative w-64 flex-shrink-0">
         <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
           <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
         </svg>
         <input 
           type="text"
           placeholder="Search"
           class="w-full bg-zinc-700 rounded-md pl-9 pr-8 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
           [value]="searchTerm()"
           (input)="onSearchChange($event.target.value)"
         />
         @if (isSearching()) {
           <button (click)="clearSearch()" class="absolute right-2 top-1/2 -translate-y-1/2 p-0.5 text-gray-400 hover:text-white rounded-full hover:bg-white/10">
             <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
             </svg>
           </button>
         }
       </div>
    </div>
    <!-- File List -->
    <div class="flex-grow overflow-auto p-4" (contextmenu)="!isSearching() && !isCloudDrive() ? onContextMenu($event) : null" (click)="onBackgroundClick($event)">
      @if (!isSearching()) {
        <table class="w-full text-left text-sm select-none">
          <thead>
            <tr class="border-b border-white/10">
              <th class="p-2 font-normal">Name</th>
              <th class="p-2 font-normal">Date modified</th>
              <th class="p-2 font-normal">Type</th>
              <th class="p-2 font-normal text-right">Size</th>
            </tr>
          </thead>
          <tbody>
            @for(item of currentItems(); track item.id) {
              <tr 
                  [draggable]="!isCloudDrive()"
                  (dragstart)="!isCloudDrive() ? onDragStart(item) : null"
                  (dragend)="!isCloudDrive() ? onDragEnd() : null"
                  (dragover)="!isCloudDrive() ? onDragOverItem($event, item) : null"
                  (dragleave)="!isCloudDrive() ? onDragLeaveItem() : null"
                  (drop)="!isCloudDrive() ? onDropOnItem($event, item) : null"
                  (click)="selectItem(item, $event)"
                  class="hover:bg-white/10 rounded transition-colors duration-100"
                  [class.opacity-40]="draggingItem()?.id === item.id"
                  [class.opacity-50]="isCut(item)"
                  [class.bg-blue-600/40]="dragOverItemId() === item.id"
                  [class.bg-blue-600/50]="selectedItem()?.id === item.id"
                  (contextmenu)="!isCloudDrive() ? onContextMenu($event, item) : null">
                <td class="p-2 flex items-center gap-2">
                  <app-file-icon [type]="item.type" [name]="item.name"></app-file-icon>
                  
                  @if (renamingItem() !== item) {
                    <span class="truncate">{{ item.name }}</span>
                  } @else {
                    <input 
                      type="text"
                      [value]="item.name"
                      [attr.data-item-id]="item.id"
                      class="bg-zinc-700 text-white px-1 py-0.5 rounded border border-blue-500 focus:outline-none w-full"
                      (blur)="finishRename($event, item)"
                      (keydown.enter)="finishRename($event, item)"
                      (keydown.escape)="cancelRename($event, item)"
                      (click)="$event.stopPropagation()"
                      (contextmenu)="$event.stopPropagation()"
                      (mousedown)="$event.stopPropagation()"
                    />
                  }
                </td>
                <td class="p-2 text-gray-400 truncate">{{ item.modified }}</td>
                <td class="p-2 text-gray-400 truncate">{{ item.type === 'folder' ? 'File folder' : item.type === 'shortcut' ? 'Shortcut' : 'File' }}</td>
                <td class="p-2 text-gray-400 text-right truncate">{{ item.size }}</td>
              </tr>
            }
          </tbody>
        </table>
      } @else {
        @if (searchResults().length > 0) {
          <div class="text-sm text-gray-400 mb-2">Found {{ searchResults().length }} item(s) for "{{ searchTerm() }}" in {{ currentPath() }} and subdirectories.</div>
          <ul class="select-none">
            @for(item of searchResults(); track item.id) {
              <li (click)="navigateToSearchResult(item)" class="flex items-center gap-3 p-2 rounded hover:bg-white/10 cursor-pointer">
                <app-file-icon [type]="item.type" [name]="item.name"></app-file-icon>
                <div>
                  <div class="text-white">{{ item.name }}</div>
                  <div class="text-xs text-gray-500">{{ item.path }}</div>
                </div>
              </li>
            }
          </ul>
        } @else {
          <div class="text-center text-gray-500 pt-10">No results found for "{{ searchTerm() }}".</div>
        }
      }
    </div>
    
    <!-- Context Menu -->
    @if (contextMenu().visible) {
      <div 
        class="absolute bg-zinc-700 border border-white/10 rounded-md shadow-lg py-1.5 w-48 z-10 text-sm animate-fade-in-fast"
        [style.left.px]="contextMenu().x"
        [style.top.px]="contextMenu().y"
        (click)="$event.stopPropagation()"
        (contextmenu)="$event.preventDefault(); $event.stopPropagation();">
        <ul>
          @if (contextMenu().item; as item) {
            @if (item.type === 'shortcut') {
              <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer font-semibold" (click)="openFileLocation()">Open file location</li>
              <hr class="border-white/10 my-1">
            }
            <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer" (click)="cutItem()">Cut</li>
            <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer" (click)="copyItem()">Copy</li>
            <hr class="border-white/10 my-1">
            <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer" (click)="deleteItem()">Delete</li>
            <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer" (click)="startRename()">Rename</li>
            <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer" (click)="createShortcut()">Create shortcut</li>
            <hr class="border-white/10 my-1">
            <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer" (click)="openProperties()">Properties</li>
          } @else {
            @if (actionHistory().length > 0) {
              <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer flex justify-between items-center" (click)="undoLastAction()">
                <span>Undo</span>
                <span class="text-xs text-gray-400">Ctrl+Z</span>
              </li>
            }
            @if (redoHistory().length > 0) {
              <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer flex justify-between items-center" (click)="redoLastAction()">
                <span>Redo</span>
                <span class="text-xs text-gray-400">Ctrl+Y</span>
              </li>
            }
            @if (actionHistory().length > 0 || redoHistory().length > 0) {
              <hr class="border-white/10 my-1">
            }
            @if(clipboardItem()){
              <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer" (click)="pasteItem()">Paste</li>
              <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer" (click)="pasteShortcut()">Paste shortcut</li>
              <hr class="border-white/10 my-1">
            }
            <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer" (click)="openMountDialog()">Mount network drive</li>
            <hr class="border-white/10 my-1">
            <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer" (click)="createNewItem('folder')">New Folder</li>
            <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer" (click)="createNewItem('file')">New File</li>
          }
        </ul>
      </div>
    }

    <!-- Sidebar Context Menu -->
    @if (sidebarContextMenu().visible) {
      <div 
        class="absolute bg-zinc-700 border border-white/10 rounded-md shadow-lg py-1.5 w-48 z-10 text-sm animate-fade-in-fast"
        [style.left.px]="sidebarContextMenu().x"
        [style.top.px]="sidebarContextMenu().y"
        (click)="$event.stopPropagation()"
        (contextmenu)="$event.preventDefault(); $event.stopPropagation();">
        <ul>
            <li class="px-3 py-1.5 hover:bg-blue-600 cursor-pointer" (click)="unmountDrive()">Unmount drive</li>
        </ul>
      </div>
    }

    <!-- Mount Drive Dialog -->
    @if (showMountDialog()) {
      <div class="absolute inset-0 bg-black/50 z-20 flex items-center justify-center" (click)="showMountDialog.set(false)">
        <div class="bg-zinc-800 border border-white/10 rounded-lg shadow-2xl w-full max-w-sm p-6" (click)="$event.stopPropagation()">
          <h2 class="text-xl font-semibold mb-4">Mount Network Drive</h2>
          <div class="space-y-4">
            <div>
              <label for="driveName" class="block text-sm text-gray-300 mb-1">Drive Name</label>
              <input 
                id="driveName"
                type="text"
                placeholder="e.g., Media Server"
                class="w-full bg-zinc-700 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                [ngModel]="mountDriveName()"
                (ngModelChange)="mountDriveName.set($event)"
                (keydown.enter)="onMountDrive()"
              />
            </div>
            <div>
              <label for="drivePath" class="block text-sm text-gray-300 mb-1">Path</label>
              <input 
                id="drivePath"
                type="text"
                placeholder="e.g., C:/Users/Shared"
                class="w-full bg-zinc-700 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                [ngModel]="mountDrivePath()"
                (ngModelChange)="mountDrivePath.set($event)"
                (keydown.enter)="onMountDrive()"
              />
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-6">
            <button (click)="showMountDialog.set(false)" class="px-4 py-1.5 bg-zinc-600 hover:bg-zinc-500 text-white rounded text-sm font-semibold">Cancel</button>
            <button (click)="onMountDrive()" [disabled]="!mountDriveName().trim() || !mountDrivePath().trim()" class="px-4 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-semibold disabled:bg-zinc-600 disabled:cursor-not-allowed">Mount</button>
          </div>
        </div>
      </div>
    }
  </div>
</div>